<!doctype html>
<html lang="fa" dir="rtl" style="height: 100%;">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´">
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItin2LPYqtmFINmF2K/bjNix24zYqiDZgdix2YjYtCDYr9in2LHZiCIsCiAgInNob3J0X25hbWUiOiAi2YXYr9uM2LHbjNiqINmB2LHZiNi0IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE1qZ2dNVEk0SWo0OGNtVmpkQ0IzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdabWxzYkQwaUl6WTJOMlZsWVNJdlBqeDBaWGgwSUhnOUlqWTBJaUI1UFNJM05DSWdabTl1ZEMxemFYcGxQU0kyTUNJZ1ptbHNiRDBpSTJabVptWm1aaUlnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK/CfjIo4TDNSbGVIUStQQzkwZEhSK1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjEyOHgxMjgiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeE1qZ2dNVEk0SWo0OGNtVmpkQ0IzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdabWxzYkQwaUl6WTJOMlZsWVNJdlBqeDBaWGgwSUhnOUlqWTBJaUI1UFNJM05DSWdabTl1ZEMxemFYcGxQU0kyTUNJZ1ptbHNiRDBpSTJabVptWm1aaUlnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK/CfjIo4TDNSbGVIUStQQzkwZEhSK1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
  <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´ Ø¯Ø§Ø±Ùˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@latest/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@latest/dist/js/persian-datepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@latest/dist/css/persian-datepicker.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Vazirmatn', sans-serif;
      margin: 0;
      padding: 0;
      height: 100%;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    * {
      box-sizing: border-box;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .input-focus:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-prescribed { background: #10b981; color: white; }
    .badge-rejected { background: #ef4444; color: white; }
    .badge-followup { background: #f59e0b; color: white; }
    .section-tab {
      padding: 8px 4px;
      background: white;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 700;
      font-size: 10px;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      flex: 1;
      text-align: center;
      min-width: 0;
    }
    .section-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-color: #4c51bf;
    }
    .section-tab .icon {
      font-size: 14px;
      display: block;
      margin-bottom: 2px;
    }
    .floating-btn {
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 40;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      font-size: 24px;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .persian-date-input {
      cursor: pointer;
      background: white;
    }
    .pwt-btn-today {
      background: #667eea !important;
      color: white !important;
    }
    .pwt-btn-submit {
      background: #10b981 !important;
      color: white !important;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body style="height: 100%; overflow-x: hidden;">
  <div style="min-height: 100%; display: flex; flex-direction: column; background: #f0f4f8;"><!-- Header -->
   <header class="gradient-bg text-white shadow-xl">
    <div class="px-4 py-3">
     <div class="text-center mb-2">
      <h1 class="text-lg font-bold mb-1">ğŸ’Š Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´</h1>
      <p class="text-xs opacity-90">âš¡ ÙˆØ­ÛŒØ¯ Ø³Ù„ÛŒÙ…ÛŒ</p>
     </div>
     <div class="grid grid-cols-4 gap-1 text-xs">
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalDoctors">
        0
       </div>
       <div class="text-xs opacity-90">
        Ù¾Ø²Ø´Ú©Ø§Ù†
       </div>
      </div>
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalPharmacies">
        0
       </div>
       <div class="text-xs opacity-90">
        Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡
       </div>
      </div>
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalVisits">
        0
       </div>
       <div class="text-xs opacity-90">
        ÙˆÛŒØ²ÛŒØª
       </div>
      </div>
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalOrders">
        0
       </div>
       <div class="text-xs opacity-90">
        Ø³ÙØ§Ø±Ø´
       </div>
      </div>
     </div>
    </div>
   </header><!-- Section Tabs -->
   <div class="px-1 pt-2">
    <div class="flex gap-0.5 overflow-x-auto"><button class="section-tab active" data-section="doctors"> <span class="icon">ğŸ‘¨â€âš•ï¸</span> <span>Ù¾Ø²Ø´Ú©Ø§Ù†</span> </button> <button class="section-tab" data-section="visits"> <span class="icon">ğŸ“‹</span> <span>ÙˆÛŒØ²ÛŒØª</span> </button> <button class="section-tab" data-section="pharmacies"> <span class="icon">ğŸ¥</span> <span>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</span> </button> <button class="section-tab" data-section="orders"> <span class="icon">ğŸ“¦</span> <span>Ø³ÙØ§Ø±Ø´</span> </button> <button class="section-tab" data-section="sales"> <span class="icon">ğŸ“Š</span> <span>ÙØ±ÙˆØ´</span> </button> <button class="section-tab" data-section="backup"> <span class="icon">ğŸ’¾</span> <span>Ø¨Ú©Ø§Ù¾</span> </button> <button class="section-tab" data-section="reports"> <span class="icon">ğŸ“„</span> <span>Ú¯Ø²Ø§Ø±Ø´</span> </button>
    </div>
   </div><!-- Main Content -->
   <main class="flex-1 px-2 pb-20 overflow-y-auto"><!-- Doctors Section -->
    <div id="doctorsSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3">
     <div class="mb-3"><input type="text" id="searchDoctorInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="doctorsList" class="space-y-2"></div>
     <div id="emptyDoctorsState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ‘¨â€âš•ï¸
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ù¾Ø²Ø´Ú©ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Visits Section -->
    <div id="visitsSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><input type="text" id="searchVisitInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="visitsList" class="space-y-2"></div>
     <div id="emptyVisitsState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ“‹
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² ÙˆÛŒØ²ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…ï¿½ï¿½ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Pharmacies Section -->
    <div id="pharmaciesSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><input type="text" id="searchPharmacyInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="pharmaciesList" class="space-y-2"></div>
     <div id="emptyPharmaciesState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ¥
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Orders Section -->
    <div id="ordersSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><input type="text" id="searchOrderInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="ordersList" class="space-y-2"></div>
     <div id="emptyOrdersState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ“¦
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Sales Section -->
    <div id="salesSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><button id="addSalesBtn" class="w-full gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow text-sm"> â• Ø«Ø¨Øª Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´ Ù‡ÙØªÚ¯ÛŒ </button>
     </div>
     <div class="bg-white rounded-lg shadow p-3 mb-3">
      <canvas id="salesChart" style="max-height: 250px;"></canvas>
     </div>
     <div id="salesList" class="space-y-2"></div>
     <div id="emptySalesState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ“Š
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Reports Section -->
    <div id="reportsSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="space-y-3">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 border-2 border-blue-200">
       <h3 class="font-bold text-sm mb-2 text-blue-900">ğŸ“„ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø§Ø¦Ù‡</h3>
       <div class="space-y-2"><select id="reportType" class="input-focus w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-xs"> <option value="doctors">Ù¾Ø²Ø´Ú©Ø§Ù†</option> <option value="pharmacies">Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§</option> <option value="both">Ù‡Ø± Ø¯Ùˆ</option> </select> <select id="reportPeriod" class="input-focus w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-xs"> <option value="weekly">Ù‡ÙØªÚ¯ÛŒ</option> <option value="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</option> <option value="custom">Ø³ÙØ§Ø±Ø´ÛŒ</option> </select>
        <div class="grid grid-cols-2 gap-2"><input type="text" id="reportFromDate" readonly class="persian-date-input input-focus w-full px-2 py-2 border-2 border-gray-300 rounded text-xs" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®"> <input type="text" id="reportToDate" readonly class="persian-date-input input-focus w-full px-2 py-2 border-2 border-gray-300 rounded text-xs" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
        </div><button id="generatePDFBtn" class="w-full bg-red-600 text-white px-4 py-2.5 rounded-lg font-bold text-xs shadow"> ğŸ“‘ ØªÙˆÙ„ÛŒØ¯ PDF </button>
       </div>
      </div>
     </div>
    </div><!-- Backup Section -->
    <div id="backupSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="space-y-3"><!-- Backup Data -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-300">
       <h3 class="font-bold text-sm mb-3 text-green-900 flex items-center gap-2">ğŸ’¾ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø¨Ú©Ø§Ù¾)</h3>
       <p class="text-xs text-gray-600 mb-3 leading-relaxed">ğŸ“¥ Ø¨Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ (Ù¾Ø²Ø´Ú©Ø§Ù†ØŒ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§ØŒ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§ØŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ Ùˆ ÙØ±ÙˆØ´) Ø¯Ø± ÛŒÚ© ÙØ§ÛŒÙ„ JSON Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p><button id="downloadBackupBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-3 rounded-lg font-bold text-sm shadow-lg flex items-center justify-center gap-2"> ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ </button>
       <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
        <p class="text-xs text-blue-800 font-semibold mb-2">ğŸ“ Ù…Ø³ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„:</p>
        <ul class="text-xs text-blue-700 space-y-1 mr-4">
         <li class="flex items-start gap-2"><span>ğŸ¤–</span> <span><strong>Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯:</strong> Downloads / Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§</span></li>
         <li class="flex items-start gap-2"><span>ğŸ</span> <span><strong>Ø¢ÛŒÙÙˆÙ†:</strong> Files &gt; Downloads</span></li>
         <li class="flex items-start gap-2"><span>ğŸ’»</span> <span><strong>Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±:</strong> Ù¾ÙˆØ´Ù‡ Downloads</span></li>
        </ul>
        <p class="text-xs text-blue-600 mt-2 font-semibold">ğŸ“Œ Ù†Ø§Ù… ÙØ§ÛŒÙ„: <span class="font-mono bg-white px-2 py-1 rounded">pharma-backup-[ØªØ§Ø±ÛŒØ®].json</span></p>
       </div>
      </div><!-- Restore Data -->
      <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg p-4 border-2 border-orange-300">
       <h3 class="font-bold text-sm mb-3 text-orange-900 flex items-center gap-2">â™»ï¸ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø¨Ú©Ø§Ù¾</h3>
       <p class="text-xs text-gray-600 mb-3 leading-relaxed">ğŸ“¤ Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ù‚Ø¨Ù„ÛŒØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
       <div class="bg-red-50 border border-red-300 rounded-lg p-3 mb-3">
        <p class="text-xs text-red-700 font-bold flex items-center gap-2">âš ï¸ Ù‡Ø´Ø¯Ø§Ø± Ù…Ù‡Ù…!</p>
        <p class="text-xs text-red-600 mt-1">Ø¨Ø§ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©Ø§Ù¾ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ù…ÛŒâ€ŒØ´ÙˆØ¯!</p>
       </div><input type="file" id="restoreFileInput" accept=".json" class="hidden"> <button id="restoreBackupBtn" class="w-full bg-gradient-to-r from-orange-500 to-amber-600 text-white px-4 py-3 rounded-lg font-bold text-sm shadow-lg flex items-center justify-center gap-2"> ğŸ“¤ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ </button>
      </div><!-- Statistics -->
      <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border-2 border-purple-300">
       <h3 class="font-bold text-sm mb-3 text-purple-900">ğŸ“Š Ø¢Ù…Ø§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</h3>
       <div class="grid grid-cols-2 gap-2">
        <div class="bg-white rounded-lg p-3 text-center border border-purple-200">
         <div class="text-2xl font-bold text-purple-600" id="backupDoctorsCount">
          0
         </div>
         <div class="text-xs text-gray-600 mt-1">
          ğŸ‘¨â€âš•ï¸ Ù¾Ø²Ø´Ú©Ø§Ù†
         </div>
        </div>
        <div class="bg-white rounded-lg p-3 text-center border border-purple-200">
         <div class="text-2xl font-bold text-purple-600" id="backupVisitsCount">
          0
         </div>
         <div class="text-xs text-gray-600 mt-1">
          ğŸ“‹ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§
         </div>
        </div>
        <div class="bg-white rounded-lg p-3 text-center border border-purple-200">
         <div class="text-2xl font-bold text-purple-600" id="backupPharmaciesCount">
          0
         </div>
         <div class="text-xs text-gray-600 mt-1">
          ğŸ¥ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡
         </div>
        </div>
        <div class="bg-white rounded-lg p-3 text-center border border-purple-200">
         <div class="text-2xl font-bold text-purple-600" id="backupOrdersCount">
          0
         </div>
         <div class="text-xs text-gray-600 mt-1">
          ğŸ“¦ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Floating Button --> <button id="floatingBtn" class="floating-btn gradient-bg text-white">â•</button> <!-- Install Button (Always Visible) --> <button id="permanentInstallBtn" class="fixed bottom-20 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-3 rounded-full shadow-2xl z-40 font-bold text-xs flex items-center gap-2 pulse"> ğŸ“± Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† </button>
   </main><!-- Footer -->
   <footer class="bg-white border-t border-gray-200 py-2 text-center">
    <p class="text-xs font-semibold text-gray-600">Â© 2024 | <span class="text-indigo-600">â­ ÙˆØ­ÛŒØ¯ Ø³Ù„ÛŒÙ…ÛŒ</span></p>
   </footer>
  </div><!-- Doctor Modal -->
  <div id="doctorModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="doctorModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ù¾Ø²Ø´Ú©</h2><button id="closeDoctorModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="doctorForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label> <input type="text" id="doctorNameInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ®ØµØµ *</label> <input type="text" id="specialtyInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label> <input type="tel" id="phoneInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù…Ù†Ø·Ù‚Ù‡ *</label> <input type="text" id="areaInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø¢Ø¯Ø±Ø³</label> <input type="text" id="addressInput" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      <div class="grid grid-cols-2 gap-2 mt-2"><button type="button" id="getDoctorLocationBtn" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1"> ğŸ“ GPS Ø®ÙˆØ¯Ú©Ø§Ø± </button> <button type="button" id="openDoctorMapBtn" class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1"> ğŸ—ºï¸ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡ </button>
      </div><input type="hidden" id="doctorLatitude"> <input type="hidden" id="doctorLongitude">
      <div id="doctorLocationStatus" class="mt-2 text-xs text-center hidden"></div>
      <div id="doctorManualLocationDiv" class="hidden mt-3 p-3 bg-yellow-50 rounded-lg border border-yellow-300">
       <p class="text-xs text-yellow-800 font-semibold mb-2">ğŸ“ ÛŒØ§ ÙˆØ±ÙˆØ¯ Ø¯Ø³ØªÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª:</p>
       <div class="space-y-2"><input type="number" step="any" id="manualDoctorLat" placeholder="Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ù…Ø«Ø§Ù„: 35.6892)" class="w-full px-2 py-1.5 border border-yellow-400 rounded text-xs"> <input type="number" step="any" id="manualDoctorLng" placeholder="Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ù…Ø«Ø§Ù„: 51.3890)" class="w-full px-2 py-1.5 border border-yellow-400 rounded text-xs"> <button type="button" id="saveManualDoctorLocation" class="w-full bg-yellow-600 text-white px-3 py-2 rounded-lg text-xs font-bold">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø³ØªÛŒ</button>
       </div>
      </div>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelDoctorBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Visit Modal -->
  <div id="visitModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="visitModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª ÙˆÛŒØ²ÛŒØª</h2><button id="closeVisitModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="visitForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú© *</label> <select id="doctorSelect" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"> <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option> </select>
     </div>
     <div class="grid grid-cols-2 gap-2">
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ§Ø±ÛŒØ® *</label> <input type="text" id="visitDate" required readonly class="persian-date-input input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
      </div>
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø³Ø§Ø¹Øª *</label> <input type="time" id="visitTime" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†ØªÛŒØ¬Ù‡ *</label> <select id="visitResult" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"> <option value="">Ø§Ù†Øªï¿½ï¿½Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option> <option value="prescribed">Ø³ÙØ§Ø±Ø´ Ø´Ø¯Ù‡</option> <option value="rejected">Ø±Ø¯ Ø´Ø¯Ù‡</option> <option value="followup">ÙˆÛŒØ²ÛŒØª Ù…Ø¬Ø¯Ø¯</option> </select>
     </div>
     <div id="followupDateSection" class="hidden"><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ğŸ“… ØªØ§Ø±ÛŒØ® ÙˆÛŒØ²ÛŒØª Ø¨Ø¹Ø¯ÛŒ *</label> <input type="text" id="followupDate" readonly class="persian-date-input input-focus w-full px-3 py-2.5 border-2 border-orange-400 rounded-lg text-sm" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
      <p class="text-xs text-orange-600 mt-1">ğŸ’¡ ÛŒÚ© Ø±ÙˆØ² Ù‚Ø¨Ù„ Ø¨Ù‡ Ø´Ù…Ø§ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label> <textarea id="visitNotes" rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelVisitBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Pharmacy Modal -->
  <div id="pharmacyModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="pharmacyModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</h2><button id="closePharmacyModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="pharmacyForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ *</label> <input type="text" id="pharmacyNameInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ³Ø§Ø² *</label> <input type="text" id="pharmacistNameInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label> <input type="tel" id="pharmacyPhoneInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø¢Ø¯Ø±Ø³ *</label> <textarea id="pharmacyAddressInput" required rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
      <div class="grid grid-cols-2 gap-2 mt-2"><button type="button" id="getPharmacyLocationBtn" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1"> ğŸ“ GPS Ø®ÙˆØ¯Ú©Ø§Ø± </button> <button type="button" id="openPharmacyMapBtn" class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1"> ğŸ—ºï¸ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡ </button>
      </div><input type="hidden" id="pharmacyLatitude"> <input type="hidden" id="pharmacyLongitude">
      <div id="pharmacyLocationStatus" class="mt-2 text-xs text-center hidden"></div>
      <div id="pharmacyManualLocationDiv" class="hidden mt-3 p-3 bg-yellow-50 rounded-lg border border-yellow-300">
       <p class="text-xs text-yellow-800 font-semibold mb-2">ğŸ“ ÛŒØ§ ÙˆØ±ÙˆØ¯ Ø¯Ø³ØªÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª:</p>
       <div class="space-y-2"><input type="number" step="any" id="manualPharmacyLat" placeholder="Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ù…Ø«Ø§Ù„: 35.6892)" class="w-full px-2 py-1.5 border border-yellow-400 rounded text-xs"> <input type="number" step="any" id="manualPharmacyLng" placeholder="Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ù…Ø«Ø§Ù„: 51.3890)" class="w-full px-2 py-1.5 border border-yellow-400 rounded text-xs"> <button type="button" id="saveManualPharmacyLocation" class="w-full bg-yellow-600 text-white px-3 py-2 rounded-lg text-xs font-bold">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø³ØªÛŒ</button>
       </div>
      </div>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelPharmacyBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="orderModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</h2><button id="closeOrderModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="orderForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ *</label> <select id="pharmacySelect" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"> <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option> </select>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ§Ø±ÛŒØ® Ø³ÙØ§Ø±Ø´ *</label> <input type="text" id="orderDate" required readonly class="persian-date-input input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ *</label> <input type="text" id="drugName" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div class="grid grid-cols-2 gap-2">
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±ØªÙ†</label> <input type="number" id="cartonQty" min="0" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø¯</label> <input type="number" id="unitQty" min="0" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label> <textarea id="orderNotes" rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelOrderBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Sales Modal -->
  <div id="salesModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="salesModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´</h2><button id="closeSalesModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="salesForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù‡ÙØªÙ‡ *</label> <input type="text" id="salesWeek" required readonly class="persian-date-input input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙØªÙ‡">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´ *</label> <input type="number" id="salesAmount" required min="0" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label> <textarea id="salesNotes" rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelSalesBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div>
  <script>
    const STORAGE_KEYS = {
      DOCTORS: 'pharma_doctors',
      VISITS: 'pharma_visits',
      PHARMACIES: 'pharma_pharmacies',
      ORDERS: 'pharma_orders',
      SALES: 'pharma_sales',
      INSTALL_DISMISSED: 'pharma_install_dismissed'
    };

    let doctors = [];
    let visits = [];
    let pharmacies = [];
    let orders = [];
    let sales = [];
    let currentSection = 'doctors';
    let editingId = null;
    let salesChart = null;
    let deferredPrompt = null;

    // PWA Installation
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    document.getElementById('permanentInstallBtn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          showToast('âœ… Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù†ØµØ¨ Ø´Ø¯!', 'success');
          document.getElementById('permanentInstallBtn').style.display = 'none';
        }
        
        deferredPrompt = null;
      } else {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (isIOS || isSafari) {
          showNotification(`ğŸ“± Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨:\n\n1. Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Share (Ø§Ø´ØªØ±Ø§Ú©) Ø¨Ø²Ù†ÛŒØ¯\n2. Ú¯Ø²ÛŒÙ†Ù‡ "Add to Home Screen" Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯`);
        } else {
          showNotification(`ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ù†ØµØ¨:\n\nØ§Ø² Ù…Ù†ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± (â‹®) Ú¯Ø²ÛŒÙ†Ù‡ "Ù†ØµØ¨ Ø¨Ø±Ù†Ø§Ù…Ù‡" ÛŒØ§ "Install App" Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯`);
        }
      }
    });

    window.addEventListener('appinstalled', () => {
      showToast('ğŸ‰ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯!', 'success');
      document.getElementById('permanentInstallBtn').style.display = 'none';
    });

    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      document.getElementById('permanentInstallBtn').style.display = 'none';
    }

    // Open Map for Doctor Location
    document.getElementById('openDoctorMapBtn').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Google Maps Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            window.open(mapsUrl, '_blank', 'noopener,noreferrer');
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±
            document.getElementById('doctorLatitude').value = lat;
            document.getElementById('doctorLongitude').value = lng;
            
            const statusDiv = document.getElementById('doctorLocationStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = `âœ… <strong>Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!</strong><br>ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
            
            showToast('ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯!', 'success');
          },
          (error) => {
            // Ø§Ú¯Ø± GPS Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù†Ù‚Ø´Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ ØªÙ‡Ø±Ø§Ù† Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
            const defaultLat = 35.6892;
            const defaultLng = 51.3890;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${defaultLat},${defaultLng}`;
            window.open(mapsUrl, '_blank', 'noopener,noreferrer');
            
            showToast('ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯ (Ù…ÙˆÙ‚Ø¹ÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶)', 'success');
            
            // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø¯Ø³ØªÛŒ
            document.getElementById('doctorManualLocationDiv').classList.remove('hidden');
          }
        );
      } else {
        // Ø§Ú¯Ø± GPS Ù†Ø¯Ø§Ø´ØªØŒ Ù†Ù‚Ø´Ù‡ ØªÙ‡Ø±Ø§Ù† Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
        const defaultLat = 35.6892;
        const defaultLng = 51.3890;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${defaultLat},${defaultLng}`;
        window.open(mapsUrl, '_blank', 'noopener,noreferrer');
        
        showToast('ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯', 'success');
        document.getElementById('doctorManualLocationDiv').classList.remove('hidden');
      }
    });

    // Geolocation for Doctor
    document.getElementById('getDoctorLocationBtn').addEventListener('click', async () => {
      const statusDiv = document.getElementById('doctorLocationStatus');
      const manualDiv = document.getElementById('doctorManualLocationDiv');
      statusDiv.classList.remove('hidden');
      
      if (!('geolocation' in navigator)) {
        statusDiv.innerHTML = 'âŒ <strong>Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ GPS Ù†Ø¯Ø§Ø±Ø¯!</strong>';
        statusDiv.className = 'mt-2 text-xs text-center text-red-600 font-bold';
        manualDiv.classList.remove('hidden');
        return;
      }

      statusDiv.innerHTML = 'ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...<br><small>Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</small>';
      statusDiv.className = 'mt-2 text-xs text-center text-blue-600 font-bold';
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          document.getElementById('doctorLatitude').value = lat;
          document.getElementById('doctorLongitude').value = lng;
          
          statusDiv.innerHTML = `âœ… <strong>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯!</strong><br>ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
          manualDiv.classList.add('hidden');
          showToast('âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
        },
        (error) => {
          statusDiv.innerHTML = 'âŒ <strong>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª!</strong><br><small>Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</small>';
          statusDiv.className = 'mt-2 text-xs text-center text-red-600 font-bold';
          manualDiv.classList.remove('hidden');
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // Manual Doctor Location
    document.getElementById('saveManualDoctorLocation').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('manualDoctorLat').value);
      const lng = parseFloat(document.getElementById('manualDoctorLng').value);
      
      if (isNaN(lat) || isNaN(lng)) {
        showToast('âŒ Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      document.getElementById('doctorLatitude').value = lat;
      document.getElementById('doctorLongitude').value = lng;
      
      const statusDiv = document.getElementById('doctorLocationStatus');
      statusDiv.innerHTML = `âœ… <strong>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯!</strong><br>ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
      statusDiv.classList.remove('hidden');
      
      document.getElementById('doctorManualLocationDiv').classList.add('hidden');
      showToast('âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!', 'success');
    });

    // Open Map for Pharmacy Location
    document.getElementById('openPharmacyMapBtn').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Google Maps Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            window.open(mapsUrl, '_blank', 'noopener,noreferrer');
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø±
            document.getElementById('pharmacyLatitude').value = lat;
            document.getElementById('pharmacyLongitude').value = lng;
            
            const statusDiv = document.getElementById('pharmacyLocationStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = `âœ… <strong>Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!</strong><br>ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
            
            showToast('ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯!', 'success');
          },
          (error) => {
            // Ø§Ú¯Ø± GPS Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù†Ù‚Ø´Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ ØªÙ‡Ø±Ø§Ù† Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
            const defaultLat = 35.6892;
            const defaultLng = 51.3890;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${defaultLat},${defaultLng}`;
            window.open(mapsUrl, '_blank', 'noopener,noreferrer');
            
            showToast('ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯ (Ù…ÙˆÙ‚Ø¹ÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶)', 'success');
            
            // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø¯Ø³ØªÛŒ
            document.getElementById('pharmacyManualLocationDiv').classList.remove('hidden');
          }
        );
      } else {
        // Ø§Ú¯Ø± GPS Ù†Ø¯Ø§Ø´ØªØŒ Ù†Ù‚Ø´Ù‡ ØªÙ‡Ø±Ø§Ù† Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
        const defaultLat = 35.6892;
        const defaultLng = 51.3890;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${defaultLat},${defaultLng}`;
        window.open(mapsUrl, '_blank', 'noopener,noreferrer');
        
        showToast('ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø² Ø´Ø¯', 'success');
        document.getElementById('pharmacyManualLocationDiv').classList.remove('hidden');
      }
    });

    // Geolocation for Pharmacy
    document.getElementById('getPharmacyLocationBtn').addEventListener('click', async () => {
      const statusDiv = document.getElementById('pharmacyLocationStatus');
      const manualDiv = document.getElementById('pharmacyManualLocationDiv');
      statusDiv.classList.remove('hidden');
      
      if (!('geolocation' in navigator)) {
        statusDiv.innerHTML = 'âŒ <strong>Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ GPS Ù†Ø¯Ø§Ø±Ø¯!</strong>';
        statusDiv.className = 'mt-2 text-xs text-center text-red-600 font-bold';
        manualDiv.classList.remove('hidden');
        return;
      }

      statusDiv.innerHTML = 'ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...<br><small>Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</small>';
      statusDiv.className = 'mt-2 text-xs text-center text-blue-600 font-bold';
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          document.getElementById('pharmacyLatitude').value = lat;
          document.getElementById('pharmacyLongitude').value = lng;
          
          statusDiv.innerHTML = `âœ… <strong>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯!</strong><br>ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
          manualDiv.classList.add('hidden');
          showToast('âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
        },
        (error) => {
          statusDiv.innerHTML = 'âŒ <strong>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª!</strong><br><small>Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</small>';
          statusDiv.className = 'mt-2 text-xs text-center text-red-600 font-bold';
          manualDiv.classList.remove('hidden');
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // Manual Pharmacy Location
    document.getElementById('saveManualPharmacyLocation').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('manualPharmacyLat').value);
      const lng = parseFloat(document.getElementById('manualPharmacyLng').value);
      
      if (isNaN(lat) || isNaN(lng)) {
        showToast('âŒ Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      document.getElementById('pharmacyLatitude').value = lat;
      document.getElementById('pharmacyLongitude').value = lng;
      
      const statusDiv = document.getElementById('pharmacyLocationStatus');
      statusDiv.innerHTML = `âœ… <strong>Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯!</strong><br>ğŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
      statusDiv.classList.remove('hidden');
      
      document.getElementById('pharmacyManualLocationDiv').classList.add('hidden');
      showToast('âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!', 'success');
    });

    function loadData() {
      try {
        doctors = JSON.parse(localStorage.getItem(STORAGE_KEYS.DOCTORS)) || [];
        visits = JSON.parse(localStorage.getItem(STORAGE_KEYS.VISITS)) || [];
        pharmacies = JSON.parse(localStorage.getItem(STORAGE_KEYS.PHARMACIES)) || [];
        orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
        sales = JSON.parse(localStorage.getItem(STORAGE_KEYS.SALES)) || [];
        
        renderAll();
        updateStats();
        renderSalesChart();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', 'error');
      }
    }

    function renderAll() {
      renderDoctors();
      renderVisits();
      renderPharmacies();
      renderOrders();
      renderSales();
      populateSelects();
    }

    function updateStats() {
      document.getElementById('totalDoctors').textContent = doctors.length;
      document.getElementById('totalPharmacies').textContent = pharmacies.length;
      document.getElementById('totalVisits').textContent = visits.length;
      document.getElementById('totalOrders').textContent = orders.length;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('fa-IR');
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('fa-IR').format(num);
    }

    // Section Switching
    document.querySelectorAll('.section-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const section = tab.dataset.section;
        currentSection = section;
        
        document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        ['doctors', 'visits', 'pharmacies', 'orders', 'sales', 'reports', 'backup'].forEach(s => {
          document.getElementById(s + 'Section').classList.add('hidden');
        });
        document.getElementById(section + 'Section').classList.remove('hidden');
        
        if (section === 'backup') {
          updateBackupStats();
        }
      });
    });

    // Floating Button
    document.getElementById('floatingBtn').addEventListener('click', () => {
      editingId = null;
      if (currentSection === 'doctors') {
        document.getElementById('doctorModal').style.display = 'flex';
      } else if (currentSection === 'visits') {
        if (doctors.length === 0) {
          showToast('âŒ Ø§Ø¨ØªØ¯Ø§ Ù¾Ø²Ø´Ú© Ø«Ø¨Øª Ú©Ù†ÛŒØ¯', 'error');
          return;
        }
        document.getElementById('visitModal').style.display = 'flex';
      } else if (currentSection === 'pharmacies') {
        document.getElementById('pharmacyModal').style.display = 'flex';
      } else if (currentSection === 'orders') {
        if (pharmacies.length === 0) {
          showToast('âŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯', 'error');
          return;
        }
        document.getElementById('orderModal').style.display = 'flex';
      }
    });

    // Render Doctors
    function renderDoctors() {
      const container = document.getElementById('doctorsList');
      const empty = document.getElementById('emptyDoctorsState');
      const searchTerm = document.getElementById('searchDoctorInput').value.toLowerCase();
      
      let filtered = doctors.filter(d => 
        d.name.toLowerCase().includes(searchTerm) ||
        d.specialty.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      container.innerHTML = filtered.map(d => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-blue-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ‘¨â€âš•ï¸ ${d.name}</h3>
              <p class="text-xs text-indigo-600">ğŸ©º ${d.specialty}</p>
              <p class="text-xs text-green-600">ğŸ“ ${d.area}</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded p-2 mb-2 text-xs">
            <p>ğŸ“ ${d.phone}</p>
            ${d.address ? `<p>ğŸ¢ ${d.address}</p>` : ''}
            ${d.latitude && d.longitude ? `<a href="https://www.google.com/maps?q=${d.latitude},${d.longitude}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">ğŸ—ºï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</a>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="editDoctor('${d.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteDoctor('${d.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Visits
    function renderVisits() {
      const container = document.getElementById('visitsList');
      const empty = document.getElementById('emptyVisitsState');
      const searchTerm = document.getElementById('searchVisitInput').value.toLowerCase();
      
      let filtered = visits.filter(v => 
        v.doctorName.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      
      const getBadge = (result) => {
        const badges = {
          prescribed: '<span class="badge badge-prescribed">ğŸ’Š Ø³ÙØ§Ø±Ø´</span>',
          rejected: '<span class="badge badge-rejected">âŒ Ø±Ø¯</span>',
          followup: '<span class="badge badge-followup">ğŸ”„ Ù…Ø¬Ø¯Ø¯</span>'
        };
        return badges[result] || '';
      };
      
      container.innerHTML = filtered.map(v => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 ${v.result === 'prescribed' ? 'border-green-500' : v.result === 'rejected' ? 'border-red-500' : 'border-orange-500'}">
          <div class="flex justify-between mb-2">
            <div>
              <div class="flex items-center gap-1 mb-1">
                <h3 class="text-sm font-bold">ğŸ‘¨â€âš•ï¸ ${v.doctorName}</h3>
                ${getBadge(v.result)}
              </div>
              <p class="text-xs text-gray-600">ğŸ“… ${formatDate(v.date)} - ${v.time}</p>
              ${v.followupDate ? `<p class="text-xs text-orange-600 font-bold mt-1">ğŸ”” ÙˆÛŒØ²ÛŒØª Ø¨Ø¹Ø¯ÛŒ: ${formatDate(v.followupDate)}</p>` : ''}
            </div>
          </div>
          ${v.notes ? `<div class="bg-gray-50 rounded p-2 mb-2 text-xs"><p>ğŸ“ ${v.notes}</p></div>` : ''}
          <div class="flex gap-2">
            <button onclick="editVisit('${v.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteVisit('${v.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Pharmacies
    function renderPharmacies() {
      const container = document.getElementById('pharmaciesList');
      const empty = document.getElementById('emptyPharmaciesState');
      const searchTerm = document.getElementById('searchPharmacyInput').value.toLowerCase();
      
      let filtered = pharmacies.filter(p => 
        p.name.toLowerCase().includes(searchTerm) ||
        p.pharmacist.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      container.innerHTML = filtered.map(p => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-green-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ¥ ${p.name}</h3>
              <p class="text-xs text-purple-600">ğŸ’Š ${p.pharmacist}</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded p-2 mb-2 text-xs">
            <p>ğŸ“ ${p.phone}</p>
            <p>ğŸ“ ${p.address}</p>
            ${p.latitude && p.longitude ? `<a href="https://www.google.com/maps?q=${p.latitude},${p.longitude}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">ğŸ—ºï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</a>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="editPharmacy('${p.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deletePharmacy('${p.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Orders
    function renderOrders() {
      const container = document.getElementById('ordersList');
      const empty = document.getElementById('emptyOrdersState');
      const searchTerm = document.getElementById('searchOrderInput').value.toLowerCase();
      
      let filtered = orders.filter(o => 
        o.pharmacyName.toLowerCase().includes(searchTerm) ||
        o.drug.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      container.innerHTML = filtered.map(o => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-purple-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ¥ ${o.pharmacyName}</h3>
              <p class="text-xs text-blue-600">ğŸ’Š ${o.drug}</p>
              <p class="text-xs text-gray-600">ğŸ“… ${formatDate(o.date)}</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded p-2 mb-2 text-xs">
            ${o.cartons > 0 ? `<p>ğŸ“¦ Ú©Ø§Ø±ØªÙ†: ${formatNumber(o.cartons)}</p>` : ''}
            ${o.units > 0 ? `<p>ğŸ”¢ Ø¹Ø¯Ø¯: ${formatNumber(o.units)}</p>` : ''}
            ${o.notes ? `<p>ğŸ“ ${o.notes}</p>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="editOrder('${o.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteOrder('${o.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Sales
    function renderSales() {
      const container = document.getElementById('salesList');
      const empty = document.getElementById('emptySalesState');
      
      if (sales.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      const sorted = [...sales].sort((a, b) => new Date(b.week) - new Date(a.week));
      
      container.innerHTML = sorted.map(s => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-indigo-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ“Š Ù‡ÙØªÙ‡ ${s.week}</h3>
              <p class="text-base text-green-600 font-bold">${formatNumber(s.amount)} Ø¹Ø¯Ø¯ ÙØ±ÙˆØ´</p>
            </div>
          </div>
          ${s.notes ? `<div class="bg-gray-50 rounded p-2 mb-2 text-xs"><p>ğŸ“ ${s.notes}</p></div>` : ''}
          <div class="flex gap-2">
            <button onclick="editSales('${s.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteSales('${s.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Sales Chart
    function renderSalesChart() {
      const ctx = document.getElementById('salesChart');
      if (!ctx) return;
      
      if (salesChart) {
        salesChart.destroy();
      }
      
      const sorted = [...sales].sort((a, b) => new Date(a.week) - new Date(b.week));
      const labels = sorted.map(s => s.week);
      const data = sorted.map(s => s.amount);
      
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´',
            data: data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatNumber(value);
                }
              }
            }
          }
        }
      });
    }

    // Populate Selects
    function populateSelects() {
      const doctorSelect = document.getElementById('doctorSelect');
      doctorSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' +
        doctors.map(d => `<option value="${d.id}">${d.name} - ${d.specialty}</option>`).join('');
      
      const pharmacySelect = document.getElementById('pharmacySelect');
      pharmacySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' +
        pharmacies.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // Modal Handlers
    document.getElementById('closeDoctorModal').addEventListener('click', () => {
      document.getElementById('doctorModal').style.display = 'none';
      document.getElementById('doctorForm').reset();
      document.getElementById('doctorLocationStatus').classList.add('hidden');
      document.getElementById('doctorManualLocationDiv').classList.add('hidden');
    });

    document.getElementById('closeVisitModal').addEventListener('click', () => {
      document.getElementById('visitModal').style.display = 'none';
      document.getElementById('visitForm').reset();
    });

    document.getElementById('closePharmacyModal').addEventListener('click', () => {
      document.getElementById('pharmacyModal').style.display = 'none';
      document.getElementById('pharmacyForm').reset();
      document.getElementById('pharmacyLocationStatus').classList.add('hidden');
      document.getElementById('pharmacyManualLocationDiv').classList.add('hidden');
    });

    document.getElementById('closeOrderModal').addEventListener('click', () => {
      document.getElementById('orderModal').style.display = 'none';
      document.getElementById('orderForm').reset();
    });

    document.getElementById('closeSalesModal').addEventListener('click', () => {
      document.getElementById('salesModal').style.display = 'none';
      document.getElementById('salesForm').reset();
    });

    document.getElementById('cancelDoctorBtn').addEventListener('click', () => {
      document.getElementById('doctorModal').style.display = 'none';
    });

    document.getElementById('cancelVisitBtn').addEventListener('click', () => {
      document.getElementById('visitModal').style.display = 'none';
    });

    document.getElementById('cancelPharmacyBtn').addEventListener('click', () => {
      document.getElementById('pharmacyModal').style.display = 'none';
    });

    document.getElementById('cancelOrderBtn').addEventListener('click', () => {
      document.getElementById('orderModal').style.display = 'none';
    });

    document.getElementById('cancelSalesBtn').addEventListener('click', () => {
      document.getElementById('salesModal').style.display = 'none';
    });

    // Form Submissions
    document.getElementById('doctorForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const data = {
        id: editingId || `doctor_${Date.now()}`,
        name: document.getElementById('doctorNameInput').value.trim(),
        specialty: document.getElementById('specialtyInput').value.trim(),
        phone: document.getElementById('phoneInput').value.trim(),
        area: document.getElementById('areaInput').value.trim(),
        address: document.getElementById('addressInput').value.trim(),
        latitude: document.getElementById('doctorLatitude').value,
        longitude: document.getElementById('doctorLongitude').value,
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = doctors.findIndex(d => d.id === editingId);
        if (index !== -1) doctors[index] = data;
      } else {
        doctors.push(data);
      }
      
      saveData(STORAGE_KEYS.DOCTORS, doctors);
      renderAll();
      updateStats();
      document.getElementById('doctorModal').style.display = 'none';
      document.getElementById('doctorForm').reset();
      document.getElementById('doctorLocationStatus').classList.add('hidden');
      document.getElementById('doctorManualLocationDiv').classList.add('hidden');
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('visitResult').addEventListener('change', (e) => {
      const followupSection = document.getElementById('followupDateSection');
      const followupInput = document.getElementById('followupDate');
      
      if (e.target.value === 'followup') {
        followupSection.classList.remove('hidden');
        followupInput.required = true;
      } else {
        followupSection.classList.add('hidden');
        followupInput.required = false;
        followupInput.value = '';
      }
    });

    document.getElementById('visitForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const doctorId = document.getElementById('doctorSelect').value;
      const doctor = doctors.find(d => d.id === doctorId);
      const result = document.getElementById('visitResult').value;
      
      const data = {
        id: editingId || `visit_${Date.now()}`,
        doctorId: doctorId,
        doctorName: doctor.name,
        date: document.getElementById('visitDate').value,
        time: document.getElementById('visitTime').value,
        result: result,
        notes: document.getElementById('visitNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (result === 'followup') {
        data.followupDate = document.getElementById('followupDate').value;
      }
      
      if (editingId) {
        const index = visits.findIndex(v => v.id === editingId);
        if (index !== -1) visits[index] = data;
      } else {
        visits.push(data);
      }
      
      saveData(STORAGE_KEYS.VISITS, visits);
      renderAll();
      updateStats();
      document.getElementById('visitModal').style.display = 'none';
      document.getElementById('visitForm').reset();
      document.getElementById('followupDateSection').classList.add('hidden');
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
      
      checkUpcomingFollowups();
    });

    document.getElementById('pharmacyForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const data = {
        id: editingId || `pharmacy_${Date.now()}`,
        name: document.getElementById('pharmacyNameInput').value.trim(),
        pharmacist: document.getElementById('pharmacistNameInput').value.trim(),
        phone: document.getElementById('pharmacyPhoneInput').value.trim(),
        address: document.getElementById('pharmacyAddressInput').value.trim(),
        latitude: document.getElementById('pharmacyLatitude').value,
        longitude: document.getElementById('pharmacyLongitude').value,
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = pharmacies.findIndex(p => p.id === editingId);
        if (index !== -1) pharmacies[index] = data;
      } else {
        pharmacies.push(data);
      }
      
      saveData(STORAGE_KEYS.PHARMACIES, pharmacies);
      renderAll();
      updateStats();
      document.getElementById('pharmacyModal').style.display = 'none';
      document.getElementById('pharmacyForm').reset();
      document.getElementById('pharmacyLocationStatus').classList.add('hidden');
      document.getElementById('pharmacyManualLocationDiv').classList.add('hidden');
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('orderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const pharmacyId = document.getElementById('pharmacySelect').value;
      const pharmacy = pharmacies.find(p => p.id === pharmacyId);
      
      const data = {
        id: editingId || `order_${Date.now()}`,
        pharmacyId: pharmacyId,
        pharmacyName: pharmacy.name,
        date: document.getElementById('orderDate').value,
        drug: document.getElementById('drugName').value.trim(),
        cartons: parseInt(document.getElementById('cartonQty').value) || 0,
        units: parseInt(document.getElementById('unitQty').value) || 0,
        notes: document.getElementById('orderNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = orders.findIndex(o => o.id === editingId);
        if (index !== -1) orders[index] = data;
      } else {
        orders.push(data);
      }
      
      saveData(STORAGE_KEYS.ORDERS, orders);
      renderAll();
      updateStats();
      document.getElementById('orderModal').style.display = 'none';
      document.getElementById('orderForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('addSalesBtn').addEventListener('click', () => {
      editingId = null;
      document.getElementById('salesModal').style.display = 'flex';
    });

    document.getElementById('salesForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const data = {
        id: editingId || `sales_${Date.now()}`,
        week: document.getElementById('salesWeek').value,
        amount: parseFloat(document.getElementById('salesAmount').value),
        notes: document.getElementById('salesNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = sales.findIndex(s => s.id === editingId);
        if (index !== -1) sales[index] = data;
      } else {
        sales.push(data);
      }
      
      saveData(STORAGE_KEYS.SALES, sales);
      renderAll();
      renderSalesChart();
      document.getElementById('salesModal').style.display = 'none';
      document.getElementById('salesForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    // Edit Functions
    window.editDoctor = function(id) {
      const item = doctors.find(d => d.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('doctorNameInput').value = item.name;
      document.getElementById('specialtyInput').value = item.specialty;
      document.getElementById('phoneInput').value = item.phone;
      document.getElementById('areaInput').value = item.area;
      document.getElementById('addressInput').value = item.address || '';
      document.getElementById('doctorLatitude').value = item.latitude || '';
      document.getElementById('doctorLongitude').value = item.longitude || '';
      
      if (item.latitude && item.longitude) {
        const statusDiv = document.getElementById('doctorLocationStatus');
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯Ù‡<br>ğŸ“ ${parseFloat(item.latitude).toFixed(6)}, ${parseFloat(item.longitude).toFixed(6)}`;
        statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
      }
      
      document.getElementById('doctorModal').style.display = 'flex';
    };

    window.editVisit = function(id) {
      const item = visits.find(v => v.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('doctorSelect').value = item.doctorId;
      document.getElementById('visitDate').value = item.date;
      document.getElementById('visitTime').value = item.time;
      document.getElementById('visitResult').value = item.result;
      document.getElementById('visitNotes').value = item.notes || '';
      
      if (item.result === 'followup' && item.followupDate) {
        document.getElementById('followupDateSection').classList.remove('hidden');
        document.getElementById('followupDate').value = item.followupDate;
        document.getElementById('followupDate').required = true;
      }
      
      document.getElementById('visitModal').style.display = 'flex';
    };

    function checkUpcomingFollowups() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      const upcoming = visits.filter(v => {
        if (!v.followupDate) return false;
        const followupDate = new Date(v.followupDate);
        followupDate.setHours(0, 0, 0, 0);
        return followupDate.getTime() === tomorrow.getTime();
      });
      
      if (upcoming.length > 0) {
        const names = upcoming.map(v => `â€¢ ${v.doctorName}`).join('\n');
        setTimeout(() => {
          showNotification(`ğŸ”” ÛŒØ§Ø¯ï¿½ï¿½ÙˆØ±ÛŒ ÙˆÛŒØ²ÛŒØª!\n\nÙØ±Ø¯Ø§ ï¿½ï¿½Ø§ÛŒØ¯ ÙˆÛŒØ²ÛŒØª Ú©Ù†ÛŒØ¯:\n${names}`);
        }, 1000);
      }
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 fade-in font-bold text-sm max-w-sm';
      notification.style.whiteSpace = 'pre-line';
      notification.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="flex-1">${message}</div>
          <button onclick="this.parentElement.parentElement.remove()" class="text-white text-xl">âœ–ï¸</button>
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.opacity = '0';
          setTimeout(() => {
            if (notification.parentElement) notification.remove();
          }, 300);
        }
      }, 10000);
    }

    window.editPharmacy = function(id) {
      const item = pharmacies.find(p => p.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('pharmacyNameInput').value = item.name;
      document.getElementById('pharmacistNameInput').value = item.pharmacist;
      document.getElementById('pharmacyPhoneInput').value = item.phone;
      document.getElementById('pharmacyAddressInput').value = item.address;
      document.getElementById('pharmacyLatitude').value = item.latitude || '';
      document.getElementById('pharmacyLongitude').value = item.longitude || '';
      
      if (item.latitude && item.longitude) {
        const statusDiv = document.getElementById('pharmacyLocationStatus');
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯Ù‡<br>ğŸ“ ${parseFloat(item.latitude).toFixed(6)}, ${parseFloat(item.longitude).toFixed(6)}`;
        statusDiv.className = 'mt-2 text-xs text-center text-green-600 font-bold';
      }
      
      document.getElementById('pharmacyModal').style.display = 'flex';
    };

    window.editOrder = function(id) {
      const item = orders.find(o => o.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('pharmacySelect').value = item.pharmacyId;
      document.getElementById('orderDate').value = item.date;
      document.getElementById('drugName').value = item.drug;
      document.getElementById('cartonQty').value = item.cartons;
      document.getElementById('unitQty').value = item.units;
      document.getElementById('orderNotes').value = item.notes || '';
      document.getElementById('orderModal').style.display = 'flex';
    };

    window.editSales = function(id) {
      const item = sales.find(s => s.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('salesWeek').value = item.week;
      document.getElementById('salesAmount').value = item.amount;
      document.getElementById('salesNotes').value = item.notes || '';
      document.getElementById('salesModal').style.display = 'flex';
    };

    // Delete Functions
    window.deleteDoctor = function(id) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm">
          <h3 class="text-lg font-bold mb-3">âš ï¸ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
          <p class="text-gray-600 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          <div class="flex gap-2">
            <button id="confirmDelete" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg font-bold">Ø­Ø°Ù</button>
            <button id="cancelDelete" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg font-bold">Ù„ØºÙˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      document.getElementById('confirmDelete').onclick = () => {
        doctors = doctors.filter(d => d.id !== id);
        saveData(STORAGE_KEYS.DOCTORS, doctors);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
        overlay.remove();
      };
      
      document.getElementById('cancelDelete').onclick = () => overlay.remove();
    };

    window.deleteVisit = function(id) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm">
          <h3 class="text-lg font-bold mb-3">âš ï¸ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
          <p class="text-gray-600 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          <div class="flex gap-2">
            <button id="confirmDelete" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg font-bold">Ø­Ø°Ù</button>
            <button id="cancelDelete" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg font-bold">Ù„ØºÙˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      document.getElementById('confirmDelete').onclick = () => {
        visits = visits.filter(v => v.id !== id);
        saveData(STORAGE_KEYS.VISITS, visits);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
        overlay.remove();
      };
      
      document.getElementById('cancelDelete').onclick = () => overlay.remove();
    };

    window.deletePharmacy = function(id) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm">
          <h3 class="text-lg font-bold mb-3">âš ï¸ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
          <p class="text-gray-600 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          <div class="flex gap-2">
            <button id="confirmDelete" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg font-bold">Ø­Ø°Ù</button>
            <button id="cancelDelete" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg font-bold">Ù„ØºÙˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      document.getElementById('confirmDelete').onclick = () => {
        pharmacies = pharmacies.filter(p => p.id !== id);
        saveData(STORAGE_KEYS.PHARMACIES, pharmacies);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
        overlay.remove();
      };
      
      document.getElementById('cancelDelete').onclick = () => overlay.remove();
    };

    window.deleteOrder = function(id) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm">
          <h3 class="text-lg font-bold mb-3">âš ï¸ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
          <p class="text-gray-600 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          <div class="flex gap-2">
            <button id="confirmDelete" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg font-bold">Ø­Ø°Ù</button>
            <button id="cancelDelete" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg font-bold">Ù„ØºÙˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      document.getElementById('confirmDelete').onclick = () => {
        orders = orders.filter(o => o.id !== id);
        saveData(STORAGE_KEYS.ORDERS, orders);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
        overlay.remove();
      };
      
      document.getElementById('cancelDelete').onclick = () => overlay.remove();
    };

    window.deleteSales = function(id) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm">
          <h3 class="text-lg font-bold mb-3">âš ï¸ ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
          <p class="text-gray-600 mb-4">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          <div class="flex gap-2">
            <button id="confirmDelete" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg font-bold">Ø­Ø°Ù</button>
            <button id="cancelDelete" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg font-bold">Ù„ØºÙˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      document.getElementById('confirmDelete').onclick = () => {
        sales = sales.filter(s => s.id !== id);
        saveData(STORAGE_KEYS.SALES, sales);
        renderAll();
        renderSalesChart();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
        overlay.remove();
      };
      
      document.getElementById('cancelDelete').onclick = () => overlay.remove();
    };

    // PDF Generation
    document.getElementById('generatePDFBtn').addEventListener('click', async () => {
      const type = document.getElementById('reportType').value;
      const period = document.getElementById('reportPeriod').value;
      const fromDate = document.getElementById('reportFromDate').value;
      const toDate = document.getElementById('reportToDate').value;
      
      showToast('ğŸ“„ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ PDF...', 'success');
      
      setTimeout(() => {
        const reportContent = generateReportHTML(type, fromDate, toDate);
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(reportContent);
        printWindow.document.close();
        printWindow.print();
        showToast('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'success');
      }, 500);
    });

    function generateReportHTML(type, fromDate, toDate) {
      const fromDateFa = fromDate ? new Date(fromDate).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯';
      const toDateFa = toDate ? new Date(toDate).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯';
      const todayFa = new Date().toLocaleDateString('fa-IR');
      
      let content = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
          <meta charset="UTF-8">
          <title>Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</title>
          <style>
            body { 
              font-family: 'Tahoma', sans-serif; 
              padding: 20px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100%;
            }
            .container {
              background: white;
              border-radius: 15px;
              padding: 30px;
              box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            }
            .header-box {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 30px;
              border-radius: 10px;
              text-align: center;
              margin-bottom: 30px;
              box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            }
            .header-box h1 {
              margin: 0 0 15px 0;
              font-size: 32px;
              font-weight: bold;
            }
            .header-box .subtitle {
              font-size: 18px;
              margin: 10px 0;
              opacity: 0.95;
            }
            .date-range {
              background: rgba(255,255,255,0.2);
              padding: 15px;
              border-radius: 8px;
              margin-top: 15px;
              font-size: 16px;
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 20px 0;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            th, td { 
              border: 1px solid #e0e0e0; 
              padding: 12px; 
              text-align: right; 
            }
            th { 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              font-weight: bold;
            }
            tbody tr:nth-child(even) {
              background: #f8f9ff;
            }
            tbody tr:hover {
              background: #e8ebff;
            }
            h2 {
              color: #667eea;
              border-right: 5px solid #667eea;
              padding-right: 15px;
              margin-top: 30px;
            }
            .footer {
              margin-top: 50px;
              padding-top: 20px;
              border-top: 3px solid #667eea;
              text-align: center;
            }
            .footer .signature {
              font-size: 18px;
              color: #333;
              margin-top: 10px;
            }
            .footer .name {
              font-weight: bold;
              color: #667eea;
              font-size: 20px;
            }
            .stats-box {
              display: flex;
              justify-content: space-around;
              margin: 20px 0;
              gap: 15px;
            }
            .stat-item {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 20px;
              border-radius: 10px;
              text-align: center;
              flex: 1;
              box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
            }
            .stat-item .number {
              font-size: 28px;
              font-weight: bold;
              margin-bottom: 5px;
            }
            .stat-item .label {
              font-size: 14px;
              opacity: 0.9;
            }
            @media print {
              body { background: white; }
              .container { box-shadow: none; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header-box">
              <h1>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h1>
              <div class="subtitle">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´ Ø¯Ø§Ø±Ùˆ</div>
              <div class="date-range">
                <strong>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ:</strong> ${fromDateFa} ØªØ§ ${toDateFa}
                <br>
                <strong>ØªØ§Ø±ÛŒØ® ØªÙ‡ÛŒÙ‡ Ú¯Ø²Ø§Ø±Ø´:</strong> ${todayFa}
              </div>
            </div>
            
            <div class="stats-box">
              <div class="stat-item">
                <div class="number">${doctors.length}</div>
                <div class="label">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø²Ø´Ú©Ø§Ù†</div>
              </div>
              <div class="stat-item">
                <div class="number">${pharmacies.length}</div>
                <div class="label">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</div>
              </div>
              <div class="stat-item">
                <div class="number">${visits.length}</div>
                <div class="label">ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ²ÛŒØª</div>
              </div>
              <div class="stat-item">
                <div class="number">${orders.length}</div>
                <div class="label">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´</div>
              </div>
            </div>
      `;
      
      if (type === 'doctors' || type === 'both') {
        let filtered = doctors;
        if (fromDate) filtered = filtered.filter(d => d.createdAt >= fromDate);
        if (toDate) filtered = filtered.filter(d => d.createdAt <= toDate);
        
        content += `
          <h2>Ù¾Ø²Ø´Ú©Ø§Ù† (${filtered.length} Ù†ÙØ±)</h2>
          <table>
            <thead>
              <tr>
                <th>Ø±Ø¯ÛŒÙ</th>
                <th>Ù†Ø§Ù…</th>
                <th>ØªØ®ØµØµ</th>
                <th>ØªÙ…Ø§Ø³</th>
                <th>Ù…Ù†Ø·Ù‚Ù‡</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map((d, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${d.name}</td>
                  <td>${d.specialty}</td>
                  <td>${d.phone}</td>
                  <td>${d.area}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      if (type === 'pharmacies' || type === 'both') {
        let filtered = pharmacies;
        if (fromDate) filtered = filtered.filter(p => p.createdAt >= fromDate);
        if (toDate) filtered = filtered.filter(p => p.createdAt <= toDate);
        
        content += `
          <h2>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§ (${filtered.length} Ù…ÙˆØ±Ø¯)</h2>
          <table>
            <thead>
              <tr>
                <th>Ø±Ø¯ÛŒÙ</th>
                <th>Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</th>
                <th>Ø¯Ø§Ø±ÙˆØ³Ø§Ø²</th>
                <th>ØªÙ…Ø§Ø³</th>
                <th>Ø¢Ø¯Ø±Ø³</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map((p, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${p.name}</td>
                  <td>${p.pharmacist}</td>
                  <td>${p.phone}</td>
                  <td>${p.address}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      content += `
            <div class="footer">
              <div class="signature">ØªÙ‡ÛŒÙ‡ Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†Ù†Ø¯Ù‡</div>
              <div class="name">â­ ÙˆØ­ÛŒØ¯ Ø³Ù„ÛŒÙ…ÛŒ</div>
            </div>
          </div>
        </body>
        </html>
      `;
      
      return content;
    }

    // Search Handlers
    document.getElementById('searchDoctorInput').addEventListener('input', renderDoctors);
    document.getElementById('searchVisitInput').addEventListener('input', renderVisits);
    document.getElementById('searchPharmacyInput').addEventListener('input', renderPharmacies);
    document.getElementById('searchOrderInput').addEventListener('input', renderOrders);

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-2xl z-50 fade-in font-bold text-sm`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 2500);
    }

    // Initialize Persian Date Pickers
    function initPersianDatePickers() {
      if (typeof $) {
        $('#visitDate').persianDatepicker({
          format: 'YYYY/MM/DD',
          initialValue: true,
          autoClose: true,
          observer: true,
          altField: '#visitDate',
          altFormat: 'YYYY-MM-DD',
          calendar: {
            persian: {
              locale: 'fa'
            }
          }
        });

        $('#followupDate').persianDatepicker({
          format: 'YYYY/MM/DD',
          autoClose: true,
          observer: true,
          altField: '#followupDate',
          altFormat: 'YYYY-MM-DD',
          calendar: {
            persian: {
              locale: 'fa'
            }
          }
        });

        $('#orderDate').persianDatepicker({
          format: 'YYYY/MM/DD',
          initialValue: true,
          autoClose: true,
          observer: true,
          altField: '#orderDate',
          altFormat: 'YYYY-MM-DD',
          calendar: {
            persian: {
              locale: 'fa'
            }
          }
        });

        $('#salesWeek').persianDatepicker({
          format: 'YYYY/MM/DD',
          initialValue: true,
          autoClose: true,
          observer: true,
          altField: '#salesWeek',
          altFormat: 'YYYY-MM-DD',
          calendar: {
            persian: {
              locale: 'fa'
            }
          }
        });

        $('#reportFromDate').persianDatepicker({
          format: 'YYYY/MM/DD',
          autoClose: true,
          observer: true,
          altField: '#reportFromDate',
          altFormat: 'YYYY-MM-DD',
          calendar: {
            persian: {
              locale: 'fa'
            }
          }
        });

        $('#reportToDate').persianDatepicker({
          format: 'YYYY/MM/DD',
          autoClose: true,
          observer: true,
          altField: '#reportToDate',
          altFormat: 'YYYY-MM-DD',
          calendar: {
            persian: {
              locale: 'fa'
            }
          }
        });
      }
    }

    // Backup Functions
    function updateBackupStats() {
      document.getElementById('backupDoctorsCount').textContent = doctors.length;
      document.getElementById('backupVisitsCount').textContent = visits.length;
      document.getElementById('backupPharmaciesCount').textContent = pharmacies.length;
      document.getElementById('backupOrdersCount').textContent = orders.length;
    }

    // Download Backup
    document.getElementById('downloadBackupBtn').addEventListener('click', () => {
      const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        data: {
          doctors: doctors,
          visits: visits,
          pharmacies: pharmacies,
          orders: orders,
          sales: sales
        }
      };
      
      const jsonString = JSON.stringify(backupData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      const date = new Date().toISOString().split('T')[0];
      link.download = `pharma-backup-${date}.json`;
      link.href = url;
      link.click();
      
      URL.revokeObjectURL(url);
      showToast('âœ… ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!', 'success');
    });

    // Restore Backup
    document.getElementById('restoreBackupBtn').addEventListener('click', () => {
      document.getElementById('restoreFileInput').click();
    });

    document.getElementById('restoreFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm">
          <h3 class="text-lg font-bold mb-3 text-orange-600">âš ï¸ ØªØ£ÛŒÛŒØ¯ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</h3>
          <p class="text-gray-700 mb-2 text-sm">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          <p class="text-red-600 text-xs mb-4 font-semibold">ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯!</p>
          <div class="flex gap-2">
            <button id="confirmRestore" class="flex-1 bg-orange-500 text-white px-4 py-2 rounded-lg font-bold text-sm">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</button>
            <button id="cancelRestore" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg font-bold text-sm">Ù„ØºÙˆ</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      document.getElementById('confirmRestore').onclick = () => {
        const reader = new FileReader();
        
        reader.onload = (event) => {
          try {
            const backupData = JSON.parse(event.target.result);
            
            if (!backupData.data || !backupData.data.doctors) {
              showToast('âŒ ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
              overlay.remove();
              return;
            }
            
            doctors = backupData.data.doctors || [];
            visits = backupData.data.visits || [];
            pharmacies = backupData.data.pharmacies || [];
            orders = backupData.data.orders || [];
            sales = backupData.data.sales || [];
            
            saveData(STORAGE_KEYS.DOCTORS, doctors);
            saveData(STORAGE_KEYS.VISITS, visits);
            saveData(STORAGE_KEYS.PHARMACIES, pharmacies);
            saveData(STORAGE_KEYS.ORDERS, orders);
            saveData(STORAGE_KEYS.SALES, sales);
            
            renderAll();
            updateStats();
            renderSalesChart();
            updateBackupStats();
            
            showToast('âœ… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
            overlay.remove();
            
            document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-section="doctors"]').classList.add('active');
            ['visits', 'pharmacies', 'orders', 'sales', 'reports', 'backup'].forEach(s => {
              document.getElementById(s + 'Section').classList.add('hidden');
            });
            document.getElementById('doctorsSection').classList.remove('hidden');
            currentSection = 'doctors';
            
          } catch (error) {
            showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„', 'error');
            overlay.remove();
          }
        };
        
        reader.readAsText(file);
      };
      
      document.getElementById('cancelRestore').onclick = () => {
        overlay.remove();
        e.target.value = '';
      };
    });

    // Initialize
    loadData();
    
    const checkJQuery = setInterval(() => {
      if (typeof $ !== 'undefined') {
        clearInterval(checkJQuery);
        initPersianDatePickers();
      }
    }, 100);
    
    checkUpcomingFollowups();
    setInterval(checkUpcomingFollowups, 3600000);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a33c7b6c6ee5d56',t:'MTc2MzkzMzU1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>